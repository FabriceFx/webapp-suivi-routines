<!DOCTYPE html>
<html>
  <head>
    <base target="_top">
    <meta charset="utf-8">
    <title>App Suivi Routines</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <style>
      body { background-color: #f4f6f9; padding-top: 20px; font-family: 'Segoe UI', sans-serif; }
      .nav-pills .nav-link.active { background-color: #4a90e2; }
      .card { border: none; border-radius: 12px; shadow: 0 2px 10px rgba(0,0,0,0.05); margin-bottom: 20px;}
      
      /* Style du grand tableau */
      .table-responsive { overflow-x: auto; }
      .matrix-table th, .matrix-table td { 
        text-align: center; 
        min-width: 38px;
        font-size: 0.8rem; 
        vertical-align: middle;
        padding: 5px 2px !important;
      }
      .matrix-table th.routine-col { 
        min-width: 140px; /* Un peu plus large pour afficher les infos */
        text-align: left; 
        position: sticky; 
        left: 0; 
        background: #fff; 
        z-index: 2;
        border-right: 2px solid #eee;
        padding-left: 10px !important;
      }
      
      /* Styles Calendrier */
      .day-name { display: block; font-size: 0.65rem; text-transform: uppercase; color: #888; font-weight: normal;}
      .day-num { display: block; font-size: 0.9rem; font-weight: bold; }
      
      /* Indicateurs visuels */
      .weekend-col { background-color: #f8f9fa; } /* Sera √©cras√© par la couleur heatmap si rempli */
      .weekend-header { color: #e74c3c; } 
      .check-done { color: #2ecc71; font-weight: bold; font-size: 1.1rem; }
      
      /* NOUVEAU : Styles Heatmap & Donn√©es */
      .routine-meta { font-size: 0.7rem; color: #999; display: block; margin-top: 2px; }
      .cell-value { font-size: 0.75rem; font-weight: bold; color: #1e5f35; } /* Vert fonc√© pour le texte sur fond clair/moyen */
      
      .chart-box { height: 250px; position: relative; }
    </style>
  </head>
  <body>
    <div class="container" style="max-width: 900px;"> 
      
      <ul class="nav nav-pills nav-fill mb-4 bg-white rounded shadow-sm p-1">
        <li class="nav-item"><button class="nav-link active" data-bs-toggle="tab" data-bs-target="#saisie">üìù Saisie</button></li>
        <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#suivi">üìä Tableau de bord</button></li>
      </ul>

      <div class="tab-content">
        
        <div class="tab-pane fade show active" id="saisie">
          <div class="card p-4" style="max-width: 500px; margin: auto;">
            <h4 class="text-center mb-4 text-primary">Loguer une activit√©</h4>
            
            <div class="mb-3">
              <label for="dateSaisie" class="form-label text-muted small">Date de r√©alisation</label>
              <input type="date" id="dateSaisie" class="form-control form-control-lg">
            </div>

            <div class="mb-3">
               <select id="selectRoutine" class="form-select form-select-lg">
                 <option selected disabled>Chargement...</option>
               </select>
            </div>

            <div id="divQuantite" class="mb-4 d-none bg-light p-3 rounded">
              <label id="lblQuantite" class="form-label text-muted small fw-bold">Quantit√©</label>
              <div class="input-group input-group-lg">
                <input type="number" id="inputValeur" class="form-control" step="0.1" placeholder="Ex: 10">
                <span class="input-group-text" id="addonUnite">unit</span>
              </div>
            </div>
            
            <button class="btn btn-primary btn-lg w-100 mb-2" id="btnValider">Valider</button>
            <button class="btn btn-outline-danger btn-sm w-100" id="btnAnnuler">Annuler la derni√®re</button>
            <div id="msgBox" class="alert mt-3 d-none text-center"></div>
          </div>
        </div>

        <div class="tab-pane fade" id="suivi">
          
          <div class="card p-3 mb-3">
            <div class="row g-2">
              <div class="col-4">
                <select id="selectAnnee" class="form-select"></select>
              </div>
              <div class="col-8">
                <select id="selectMois" class="form-select">
                  <option value="1">Janvier</option><option value="2">F√©vrier</option><option value="3">Mars</option>
                  <option value="4">Avril</option><option value="5">Mai</option><option value="6">Juin</option>
                  <option value="7">Juillet</option><option value="8">Ao√ªt</option><option value="9">Septembre</option>
                  <option value="10">Octobre</option><option value="11">Novembre</option><option value="12">D√©cembre</option>
                </select>
              </div>
            </div>
          </div>

          <div class="row">
            <div class="col-md-6">
              <div class="card p-3">
                <h6 class="text-center text-muted">R√©partition par Routine</h6>
                <div class="chart-box"><canvas id="pieChart"></canvas></div>
              </div>
            </div>
            <div class="col-md-6">
              <div class="card p-3">
                <h6 class="text-center text-muted">Constance Quotidienne</h6>
                <div class="chart-box"><canvas id="lineChart"></canvas></div>
              </div>
            </div>
          </div>

          <div class="card p-3 mt-3">
            <h5 class="mb-3">D√©tail journalier (Heatmap)</h5>
            <div class="table-responsive">
              <table class="table table-bordered table-sm matrix-table" id="matrixTable">
                <thead></thead>
                <tbody></tbody>
              </table>
            </div>
          </div>

        </div>
      </div>
    </div>

    <script>
      // Stockage global
      let listeRoutinesGlobal = []; 
      const charts = { pie: null, line: null }; 

      // Initialisation
      window.addEventListener('load', () => {
        initialiserSelecteurs();
        chargerListeRoutines();
        
        // Date par d√©faut : Aujourd'hui
        document.getElementById('dateSaisie').value = new Date().toISOString().split('T')[0];
        
        // Listeners
        document.getElementById('btnValider').addEventListener('click', gererSauvegarde);
        document.getElementById('btnAnnuler').addEventListener('click', gererAnnulation);
        document.getElementById('selectAnnee').addEventListener('change', chargerRapport);
        document.getElementById('selectMois').addEventListener('change', chargerRapport);
        
        // NOUVEAU : D√©tection changement routine pour afficher l'input quantit√©
        document.getElementById('selectRoutine').addEventListener('change', mettreAJourInterfaceSaisie);
      });

      // --- SETUP UI ---

      const initialiserSelecteurs = () => {
        const selectAnnee = document.getElementById('selectAnnee');
        const anneeActuelle = new Date().getFullYear();
        for (let i = anneeActuelle - 1; i <= anneeActuelle + 2; i++) {
          const opt = document.createElement('option');
          opt.value = i; opt.text = i;
          if (i === anneeActuelle) opt.selected = true;
          selectAnnee.add(opt);
        }
        document.getElementById('selectMois').value = new Date().getMonth() + 1;
      };

      const chargerListeRoutines = () => {
        google.script.run
          .withSuccessHandler((liste) => {
            listeRoutinesGlobal = liste; // Stockage en m√©moire
            const select = document.getElementById('selectRoutine');
            select.innerHTML = '<option disabled selected>-- Choisir --</option>';
            
            liste.forEach(item => {
               const opt = document.createElement('option');
               opt.value = item.nom; 
               opt.text = item.nom;
               select.add(opt);
            });
            chargerRapport();
          })
          .withFailureHandler(afficherErreur)
          .recupererListeRoutines(); 
      };

      // --- LOGIQUE SAISIE ---

      const mettreAJourInterfaceSaisie = () => {
        const nomSelectionne = document.getElementById('selectRoutine').value;
        const routineTrouvee = listeRoutinesGlobal.find(r => r.nom === nomSelectionne);
        const divQuantite = document.getElementById('divQuantite');
        
        // Si la routine a une "unite" d√©finie en Config, on affiche le champ
        if (routineTrouvee && routineTrouvee.unite) {
          divQuantite.classList.remove('d-none');
          document.getElementById('lblQuantite').innerText = `Quantit√© (${routineTrouvee.unite})`;
          document.getElementById('addonUnite').innerText = routineTrouvee.unite;
          document.getElementById('inputValeur').focus();
        } else {
          divQuantite.classList.add('d-none');
        }
        // Reset valeur √† chaque changement pour √©viter les erreurs
        document.getElementById('inputValeur').value = ''; 
      };

      const gererSauvegarde = () => {
        const nom = document.getElementById('selectRoutine').value;
        const date = document.getElementById('dateSaisie').value;
        const valeur = document.getElementById('inputValeur').value; 

        if (nom.startsWith('--')) return afficherMessage("Veuillez choisir une routine", "warning");
        if (!date) return afficherMessage("Date invalide", "warning");
        
        // Validation : Si le champ est visible, il doit √™tre rempli
        const divVisible = !document.getElementById('divQuantite').classList.contains('d-none');
        if (divVisible && !valeur) return afficherMessage("Veuillez saisir une quantit√©", "warning");

        basculerInterfaceChargement(true);
        
        google.script.run
          .withSuccessHandler((msg) => {
             basculerInterfaceChargement(false);
             afficherMessage(msg, 'success');
             chargerRapport();
             // On vide le champ valeur pour la prochaine saisie
             document.getElementById('inputValeur').value = '';
          })
          .withFailureHandler((err) => {
             basculerInterfaceChargement(false); 
             afficherErreur(err);
          })
          .sauvegarderRoutine(nom, date, valeur); // 3 arguments envoy√©s
      };

      const gererAnnulation = () => {
        if (!confirm("Supprimer la derni√®re entr√©e ?")) return;
        basculerInterfaceChargement(true);
        google.script.run
          .withSuccessHandler((msg) => {
            basculerInterfaceChargement(false);
            afficherMessage(msg, 'danger');
            chargerRapport(); 
          })
          .withFailureHandler(err => {
            basculerInterfaceChargement(false); afficherErreur(err);
          })
          .supprimerDerniereEntree(); 
      };

      // --- LOGIQUE DASHBOARD ---

      const chargerRapport = () => {
        const annee = document.getElementById('selectAnnee').value;
        const mois = document.getElementById('selectMois').value;
        document.querySelector('tbody').style.opacity = '0.5';
        
        google.script.run
          .withSuccessHandler(rendreTableauDeBord)
          .withFailureHandler(afficherErreur)
          .genererRapportMensuel(Number(annee), Number(mois));
      };

      const rendreTableauDeBord = (rapport) => {
         document.querySelector('tbody').style.opacity = '1';
         
         // 1. G√©n√©ration de la Heatmap
         genererMatriceHTML(rapport);
         
         // 2. Adaptation des donn√©es pour les graphiques (Mode binaire : Fait / Pas fait)
         // Le backend renvoie maintenant un objet {jour: valeur}
         // Les graphiques attendent un tableau de jours [1, 5, 10]
         const rapportPourGraphe = {
           routines: rapport.routines,
           statsJournalieres: rapport.statsJournalieres,
           joursDansLeMois: rapport.joursDansLeMois,
           donnees: {} 
         };
         
         // Conversion pour compatibilit√© Chart.js
         rapport.routines.forEach(r => {
            const donneesRoutine = rapport.donnees[r.nom] || {};
            // On prend juste les cl√©s (les jours o√π il y a eu activit√©)
            const joursActifs = Object.keys(donneesRoutine).map(Number);
            rapportPourGraphe.donnees[r.nom] = joursActifs;
         });
         
         genererGraphiques(rapportPourGraphe);
      };

      const genererMatriceHTML = (rapport) => {
        const tbody = document.querySelector('#matrixTable tbody');
        const thead = document.querySelector('#matrixTable thead');
        tbody.innerHTML = ''; 
        thead.innerHTML = '';
        
        // En-t√™tes (Jours)
        const trHead = document.createElement('tr');
        trHead.innerHTML = '<th class="routine-col">Routine</th>';
        const annee = parseInt(document.getElementById('selectAnnee').value);
        const mois = parseInt(document.getElementById('selectMois').value);
        const joursSemaine = ['DIM','LUN','MAR','MER','JEU','VEN','SAM'];

        for (let j = 1; j <= rapport.joursDansLeMois; j++) {
           const d = new Date(annee, mois-1, j);
           const isWE = (d.getDay()===0 || d.getDay()===6);
           trHead.innerHTML += `<th class="${isWE?'weekend-header':''}"><span class="day-num">${j}</span></th>`;
        }
        thead.appendChild(trHead);

        // Corps
        rapport.routines.forEach(item => {
           const nom = item.nom;
           const obj = item.objectif; 
           const unite = item.unite;
           const dataRoutine = rapport.donnees[nom] || {};
           
           // Affichage de l'objectif sous le nom
           let infoSup = '';
           if(unite) infoSup = `<span class="routine-meta">Obj: ${obj} ${unite}/j</span>`;
           else if(obj > 0) infoSup = `<span class="routine-meta">Obj: ${obj} /mois</span>`;
           
           const tr = document.createElement('tr');
           tr.innerHTML = `<th class="routine-col"><div>${nom}</div>${infoSup}</th>`;
           
           for (let j = 1; j <= rapport.joursDansLeMois; j++) {
              const valeurJour = dataRoutine[j]; // Valeur (ex: 10) ou undefined
              const d = new Date(annee, mois-1, j);
              const isWE = (d.getDay()===0 || d.getDay()===6);
              
              let styleTd = isWE ? 'background-color:#f8f9fa;' : '';
              let contenu = '';

              if (valeurJour !== undefined) {
                 if (unite) {
                    // --- MODE QUANTITATIF (HEATMAP) ---
                    // Calcul opacit√© : on sature √† 1 si d√©passe l'objectif
                    const ratio = obj > 0 ? Math.min(valeurJour / obj, 1) : 1;
                    // Opacit√© min 0.25 pour rester lisible m√™me si petit score
                    const alpha = Math.max(ratio, 0.25);
                    
                    // Vert : rgba(46, 204, 113, alpha)
                    styleTd = `background-color: rgba(46, 204, 113, ${alpha});`;
                    contenu = `<span class="cell-value" style="color:${alpha > 0.6 ? '#fff' : '#1e5f35'}">${valeurJour}</span>`;
                 } else {
                    // --- MODE STANDARD (CHECK) ---
                    contenu = `<span class="check-done">‚óè</span>`;
                 }
              }
              
              tr.innerHTML += `<td style="${styleTd}">${contenu}</td>`;
           }
           tbody.appendChild(tr);
        });
      };

      const genererGraphiques = (rapport) => {
        // Adaptation simple : on affiche des graphes bas√©s sur la fr√©quence (nombre de fois)
        const labels = rapport.routines.map(r => r.nom);
        const dataPie = labels.map(nom => (rapport.donnees[nom] || []).length);
        
        const joursLabels = [];
        const dataLine = [];
        
        for (let i = 1; i <= rapport.joursDansLeMois; i++) {
          joursLabels.push(i);
          dataLine.push(rapport.statsJournalieres[i] || 0);
        }

        // --- Pie Chart ---
        if (charts.pie) charts.pie.destroy();
        charts.pie = new Chart(document.getElementById('pieChart'), {
          type: 'doughnut',
          data: {
            labels: labels,
            datasets: [{
              data: dataPie,
              backgroundColor: ['#3498db', '#e74c3c', '#2ecc71', '#f1c40f', '#9b59b6', '#e67e22', '#1abc9c'],
              borderWidth: 1
            }]
          },
          options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'bottom', labels: { boxWidth: 12 } } } }
        });

        // --- Line Chart ---
        if (charts.line) charts.line.destroy();
        charts.line = new Chart(document.getElementById('lineChart'), {
          type: 'line',
          data: {
            labels: joursLabels,
            datasets: [{
              label: 'Actions totales',
              data: dataLine,
              borderColor: '#34495e',
              backgroundColor: 'rgba(52, 73, 94, 0.1)',
              fill: true,
              tension: 0.3
            }]
          },
          options: { 
            responsive: true, 
            maintainAspectRatio: false,
            scales: { y: { beginAtZero: true, ticks: { stepSize: 1 } }, x: { grid: { display: false } } },
            plugins: { legend: { display: false } }
          }
        });
      };

      // --- HELPERS ---
      const basculerInterfaceChargement = (etat) => {
        const btn = document.getElementById('btnValider');
        btn.disabled = etat;
        btn.innerText = etat ? "Traitement..." : "Valider";
      };

      const afficherMessage = (texte, type) => {
        const box = document.getElementById('msgBox');
        box.className = `alert mt-3 alert-${type}`;
        box.innerText = texte;
        box.classList.remove('d-none');
        setTimeout(() => box.classList.add('d-none'), 3000);
      };
      
      const afficherErreur = (err) => {
        console.error(err);
        afficherMessage("Erreur: " + err.message, 'danger');
      };
    </script>
    
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
  </body>
</html>
